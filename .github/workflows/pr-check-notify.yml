# Spara i: .github/workflows/pr-check.notifyslack.yml

# 1. Namnet på ditt workflow
name: .NET PR Check med Slack Notis

# 2. Triggers (När ska detta köras?)
on:
  pull_request:
    branches: [ main ] # Körs när en PR öppnas/uppdateras mot 'main'

# 3. Jobb (Vad ska göras?)
jobs:
  build-test-and-notify:
    runs-on: ubuntu-latest # Vilken typ av maskin som ska användas
    steps:
      
      # Steg 1: Checka ut koden från PR:n
      - name: Kassa ut koden
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # Steg 2: Sätt upp, bygg och testa .NET 8
      # -----------------------------------------------------------------
      
      # Sätter upp rätt version av .NET SDK
      - name: Sätt upp .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      # Återställer alla NuGet-paket
      # ÄNDRING: Rättad sökväg (tog bort src/)
      - name: Återställ dependencies (dotnet restore)
        run: dotnet restore ./StudyTeknik.sln

      # Bygger solution-filen
      # ÄNDRING: Rättad sökväg (tog bort src/)
      - name: Bygg projektet (dotnet build)
        run: dotnet build ./StudyTeknik.sln --no-restore

      # Kör alla tester
      # ÄNDRING 1: Rättad sökväg (tog bort src/)
      # ÄNDRING 2: Kör utan --no-build för att fixa deps.json-felet i CI
      - name: Kör tester (dotnet test)
        run: dotnet test ./StudyTeknik.sln
      
      # -----------------------------------------------------------------

      # Steg 3: Skicka Slack-avisering
      - name: Skicka Slack-avisering
        if: always() 
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }} 
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }} 
          SLACK_TITLE: ".NET PR Check: ${{ job.status }}"
          SLACK_USERNAME: "GitHub Actions Bot"
          SLACK_MESSAGE: |
            En pull request för *.NET* av *${{ github.actor }}* fick statusen: *${{ job.status }}*
            Branch: `${{ github.head_ref }}`
            Repo: `${{ github.repository }}`
          SLACK_FOOTER: "Se ändringar: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
